# Инструкция по настройке ежедневного обновления товаров

## Обзор системы

Система ежедневного обновления автоматически обновляет цены и названия всех активных товаров в базе данных. Обновление происходит для товаров, которые отслеживают пользователи.

## Компоненты системы

### 1. Функции в database.py
- `daily_update_all_products()` - основная функция обновления
- `get_daily_update_stats()` - получение статистики обновлений
- `get_products_for_daily_update()` - получение списка товаров для обновления

### 2. Скрипты обновления
- `daily_update_simple.py` - упрощенный скрипт для ручного запуска
- `daily_update.bat` - Windows-скрипт для планировщика задач

### 3. API endpoints
- `/api/daily-update` - запуск обновления через веб-интерфейс
- `/api/update-stats` - получение статистики обновлений

## Способы запуска обновления

### 1. Ручной запуск через командную строку
```bash
# Запуск обновления
python daily_update_simple.py

# Просмотр статистики
python daily_update_simple.py stats
```

### 2. Через веб-интерфейс
- Откройте: `http://127.0.0.1:5000/api/daily-update`
- Для статистики: `http://127.0.0.1:5000/api/update-stats`

### 3. Автоматический запуск через планировщик задач Windows

#### Настройка планировщика задач:
1. Откройте "Планировщик задач" (Task Scheduler)
2. Создайте новую задачу:
   - **Имя**: "Ежедневное обновление цен товаров"
   - **Триггер**: Ежедневно в 09:00 и 18:00
   - **Действие**: Запуск программы `daily_update.bat`
   - **Рабочая папка**: `D:\MKT_PRICE`

#### Альтернативный способ через PowerShell:
```powershell
# Создание задачи на 09:00
schtasks /create /tn "DailyPriceUpdate" /tr "D:\MKT_PRICE\daily_update.bat" /sc daily /st 09:00

# Создание задачи на 18:00
schtasks /create /tn "DailyPriceUpdateEvening" /tr "D:\MKT_PRICE\daily_update.bat" /sc daily /st 18:00
```

## Что происходит при обновлении

1. **Получение списка товаров**: Система находит все активные товары, которые отслеживают пользователи
2. **Обновление данных**: Для каждого товара:
   - Получает актуальную цену и название с Ozon.ru
   - Округляет цену в большую сторону
   - Обновляет основную таблицу SKU
   - Добавляет запись в историю цен (PriceHistory)
   - Добавляет запись в ежедневные цены (DailyPrices)
3. **Пауза между запросами**: 1 секунда между обновлениями товаров
4. **Отчет о результатах**: Количество обновленных товаров и ошибок

## Мониторинг и статистика

### Статистика включает:
- Количество товаров для обновления
- Количество обновлений за последние 7 дней
- Дата последнего обновления

### Логирование:
- Все операции логируются в консоль
- Ошибки обрабатываются и не останавливают процесс
- Результаты сохраняются в базу данных

## Рекомендации

1. **Время запуска**: Рекомендуется запускать в нерабочее время (утром и вечером)
2. **Мониторинг**: Регулярно проверяйте статистику обновлений
3. **Резервное копирование**: Делайте резервные копии базы данных перед массовыми обновлениями
4. **Тестирование**: Сначала протестируйте на небольшом количестве товаров

## Устранение проблем

### Если обновление не работает:
1. Проверьте подключение к интернету
2. Убедитесь, что приложение Flask запущено
3. Проверьте логи на наличие ошибок
4. Убедитесь, что в базе есть активные товары

### Если возникают ошибки кодировки:
- Система автоматически обрабатывает проблемы с русскими символами
- Ошибки не критичны и не останавливают процесс

## Примеры использования

### Проверка статистики:
```bash
python daily_update_simple.py stats
```

### Запуск обновления:
```bash
python daily_update_simple.py
```

### Через API:
```bash
curl http://127.0.0.1:5000/api/update-stats
curl http://127.0.0.1:5000/api/daily-update
```
